<?php
include "config.php";
include ("includes/utilities.php");

$title = "Ajout d'article";

redirect_login();

?>

<html>
   <?php include ("includes/head.php") ?>
   <?php include ("includes/header.php"); ?>
    <body>
        <article>
<form  method="post" action="" enctype="multipart/form-data">     
    <label for="article_name">Nom de l'article :</label>
    <input type="text" id="article_name" name="article_name" required
       minlength="1" maxlength="100" size="50"><br/><br/>
       <textarea name="article_text" id="article_text" cols="50" rows="10"></textarea><br/><br/>
    <label for="article_image">Choisir une image d'illustration:</label>

<input type="file"
       id="article_image" name="article_image"
       accept="image/png, image/jpeg">
       <br/><br/>
       <label for="article_private">Article privé : </label>

       <input type="checkbox"  name="article_private" id="article_private"/>
       <br/><br/>
       <input type="submit" name="article_submit" value="Soumettre" />

</form>
</article>

<aside>

<?php
if (isset($_POST['article_submit']))
{

    //Gestion du fichier
    if (isset($_FILES["article_image"]))
    {
        $target_dir = "uploads/";
        $newfilename = date('dmYHis') . str_replace(" ", "", basename($_FILES["article_image"]["name"]));
        $target_file = $target_dir . $newfilename;
        $uploadOk = 1;
        $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));
        
        $textfile = $_FILES["article_image"]["name"];
        $fileok = false;
        if (isset($textfile) && preg_match('/\.(jpg|png|jpeg)/', $textfile)){
            if (isset($_FILES["article_image"]["type"]) && preg_match('/(image\/png|image\/jpg|image\/jpeg)/', $_FILES["article_image"]["type"])){
                if(!($_FILES["article_image"]["size"] > 100000)){    
                    if (move_uploaded_file($_FILES["article_image"]["tmp_name"], $target_file)){
                        system("chmod 400 $target_file");
                    }
                    else {
                        echo "Il y a eu un problème avec l'import du fichier";
                    }
                        $fileok = true;
                        $contentOk = "Article ajouté !";                   
                }
                else{
                    $contentOk = "File too large file";
                }
            }
            else {
                $contentOk = "wrong content type. use image/png or image/jpg content type";
            }
        }
        else{
            $contentOk = " wrong file extension. use .png .jpg extension";
        }
    }
    
    $private = false;
    if (isset($_POST["article_private"]))
    {
        $private = true;
    }
    if ($fileok ===  true){
        //----------CODE ADDED TO PATCH XSS STOCKED----------//
        $_POST["article_name"] = strip_tags($_POST["article_name"]); //Suppression des éventuels tags présents dans le titre de l'article
        $_POST["article_text"] = strip_tags($_POST["article_text"]); //Suppression des éventuels tags présents dans le texte de l'article
        //--------------------------------------------------//
        $sql = "INSERT INTO news (title, content, filename, is_private, author_id) VALUES (?, ?, ?, ?, ?)";
        $stmt = $con->prepare($sql);
        $stmt->bind_param("sssii", $_POST["article_name"], $_POST["article_text"], $newfilename, $private, $_SESSION["id"]);
        $stmt->execute();
        $stmt->close();
        $con->close();
        //$contentOk = $_FILES["article_image"]["type"];
        //$contentOk = $textfile;
        if (isset($contentOk)){
            echo ("<strong> $contentOk </Strong>");
        }
        else {
            echo ("error in the upload");
        }
    }
    else {
        echo ("<strong> file not uploaded reason : $contentOk </strong>");
    }
    
}

?>


</aside>
    </body>
</html>
